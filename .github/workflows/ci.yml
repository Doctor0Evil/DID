name: CI

permissions:
  contents: read

on:
  push:
    branches: [ main, 'feature/**' ]
  pull_request:
    branches: [ main ]

jobs:

  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run init
        run: make init

      
      - name: Run secret scan
        run: make secret-scan
      - name: Run lint
        run: make lint

      - name: Run tests
        run: make test

      - name: Echo DID identity anchor
        run: echo "Using DID identity anchor from config/identity.web5.json"
      # OIDC ID token is obtained using GitHub's built-in OIDC support (ACTIONS_ID_TOKEN_REQUEST_URL/TOKEN).
      # Short-lived DID session is written to $GITHUB_ENV and is job-scoped; do not export tokens via job outputs or echo them.
      # To reuse DID session in another job, run the did-auth step in that job or use secure secret managers; do not serialize tokens into artifacts or job outputs.
      - name: did-auth: exchange
        id: did-auth
        run: |
          set -e
          node scripts/did-auth-exchange.js || exit 1
          # Do not print token or response - script writes token to $GITHUB_ENV

      - name: Show identity config (sanity)
        run: cat ./config/identity.web5.json

      # Example: Safe way to reuse did-auth in another job
      # deploy-example:
      #   name: Deploy Example (commented)
      #   runs-on: ubuntu-latest
      #   permissions:
      #     id-token: write
      #     contents: read
      #   steps:
      #     - name: Checkout
      #       uses: actions/checkout@v4
      #     - name: did-auth: exchange (job-scoped)
      #       run: |
      #         # Prefer performing did-auth in this job for a job-scoped token
      #         node scripts/did-auth-exchange.js || exit 1
      #     - name: Use token safely
      #       run: |
      #         # Use $GITHUB_ENV provided token only in this job
      #         echo "Uses job-scoped DID_WEB5_SESSION_TOKEN"
      #
      # Alternative: Use an external secret manager / Web5 agent and avoid serializing tokens across jobs.
      # Do not pass DID_WEB5_SESSION_TOKEN via job outputs or write it to artifacts; each job should obtain its own token or use a secure store.
      - name: Dry-run DID resolver (local)
        run: |
          node -e "require('./scripts/resolve-did.js');"

# Example: Call the reusable did-auth workflow as a `workflow_call` from another job.
# Uncomment and configure the inputs to use in your project. This example demonstrates
# two safe patterns: run the did-auth step inside the job for a job-scoped token OR use the
# reusable workflow and run downstream steps in the same job. Do NOT pass tokens via outputs/artifacts.
#
# did-auth-reuse-example:
#   runs-on: ubuntu-latest
#   permissions:
#     id-token: write
#     contents: read
#   steps:
#     - name: Reuse did-auth reusable workflow
#       # In development you can reference `@main` or a relative path, but for published usage
#       # callers should reference a pinned tag such as `@v1.0.0`:
#       uses: Doctor0Evil/DID/.github/workflows/did-auth-reusable.yml@v1.0.0
#       with:
#         working-directory: '.'
#         did_config_path: 'config/identity.web5.json'
#         resolver_dry_run: 'true'
#     - name: Use job-scoped DID token
#       run: |
#         # The token is job-scoped and available via $GITHUB_ENV; do not attempt to print the token.
#         echo "Downstream steps can use the job-scoped DID_WEB5_SESSION_TOKEN from an env var"

# Note: This workflow does not include secrets or token references. Integration with a Web5/DID agent
# should be performed by reusable workflows or external actions that resolve credentials at runtime.
